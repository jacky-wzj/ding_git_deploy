# æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é’‰é’‰æœåŠ¡å™¨                               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚   é’‰é’‰ç¾¤     â”‚         â”‚ é’‰é’‰æœºå™¨äººAPI â”‚                    â”‚
â”‚  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚                    â”‚
â”‚  â”‚  @éƒ¨ç½²åŠ©æ‰‹   â”‚         â”‚   Webhook    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                  â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚ HTTPS POST
                                   â”‚ ç­¾åéªŒè¯
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä½ çš„æœåŠ¡å™¨                                  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Nginx (åå‘ä»£ç†)                          â”‚   â”‚
â”‚  â”‚  - SSL/TLS ç»ˆæ­¢                                        â”‚   â”‚
â”‚  â”‚  - è´Ÿè½½å‡è¡¡                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚ proxy_pass                            â”‚
â”‚                        â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          Node.js æœåŠ¡ (PM2 å®ˆæŠ¤)                       â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚   Express Web Server                         â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                                              â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ POST /webhookâ”‚   â”‚  POST /deploy    â”‚   â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  /dingtalk   â”‚   â”‚  (æ‰‹åŠ¨è§¦å‘)      â”‚   â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚                    â”‚              â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                   â–¼                         â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  ç­¾åéªŒè¯æ¨¡å—     â”‚               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                  â–¼                         â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚   éƒ¨ç½²æ‰§è¡Œæ¨¡å—    â”‚               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚                  â”‚               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  1. git pull     â”‚               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  2. pnpm install â”‚               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  3. pnpm build   â”‚               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  4. nginx reload â”‚               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                  â”‚                         â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                  â–¼                         â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  æ¶ˆæ¯å‘é€æ¨¡å—     â”‚               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  (å‘é€åˆ°é’‰é’‰)    â”‚               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                                              â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚              æ—¥å¿—æ¨¡å— (Winston)              â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  - deploy.log  (éƒ¨ç½²æ—¥å¿—)                   â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  - error.log   (é”™è¯¯æ—¥å¿—)                   â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           é¡¹ç›®ç›®å½• (/var/www/your-project)             â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  - .git/                                              â”‚   â”‚
â”‚  â”‚  - node_modules/                                      â”‚   â”‚
â”‚  â”‚  - dist/         (æ„å»ºè¾“å‡º)                           â”‚   â”‚
â”‚  â”‚  - package.json                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. æ¶ˆæ¯è§¦å‘æµç¨‹

```
ç”¨æˆ·æ“ä½œ                é’‰é’‰æœåŠ¡å™¨              ä½ çš„æœåŠ¡å™¨
   â”‚                        â”‚                      â”‚
   â”‚  @éƒ¨ç½²åŠ©æ‰‹ deploy      â”‚                      â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
   â”‚                        â”‚                      â”‚
   â”‚                        â”‚ POST /webhook        â”‚
   â”‚                        â”‚ + ç­¾åéªŒè¯           â”‚
   â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                        â”‚                      â”‚
   â”‚                        â”‚ HTTP 200 OK          â”‚
   â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                        â”‚                      â”‚
   â”‚                        â”‚                      â”‚ [å¼‚æ­¥æ‰§è¡Œéƒ¨ç½²]
   â”‚                        â”‚                      â”‚
   â”‚  æ”¶åˆ°æ¶ˆæ¯: "ğŸš€å¼€å§‹éƒ¨ç½²" â”‚                      â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                        â”‚                      â”‚
   â”‚                        â”‚                      â”‚ [æ‰§è¡Œå‘½ä»¤...]
   â”‚                        â”‚                      â”‚
   â”‚  æ”¶åˆ°æ¶ˆæ¯: "âœ…éƒ¨ç½²æˆåŠŸ" â”‚                      â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                        â”‚                      â”‚
```

### 2. éƒ¨ç½²æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ”¶åˆ°éƒ¨ç½²è¯·æ±‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éªŒè¯é’‰é’‰ç­¾å        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¿«é€Ÿå“åº” 200 OK     â”‚  (é¿å…é’‰é’‰è¶…æ—¶)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼‚æ­¥æ‰§è¡Œéƒ¨ç½²ä»»åŠ¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1: git pull origin main           â”‚
â”‚  ----------------------------------------â”‚
â”‚  cd /var/www/your-project              â”‚
â”‚  git pull origin main                   â”‚
â”‚  ----------------------------------------â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»§ç»­                         â”‚
â”‚  âŒ å¤±è´¥ â†’ åœæ­¢å¹¶é€šçŸ¥                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2: pnpm install                   â”‚
â”‚  ----------------------------------------â”‚
â”‚  pnpm install --prod=false             â”‚
â”‚  ----------------------------------------â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»§ç»­                         â”‚
â”‚  âŒ å¤±è´¥ â†’ åœæ­¢å¹¶é€šçŸ¥                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3: pnpm build                     â”‚
â”‚  ----------------------------------------â”‚
â”‚  pnpm build                             â”‚
â”‚  ----------------------------------------â”‚
â”‚  âœ… æˆåŠŸ â†’ ç»§ç»­                         â”‚
â”‚  âŒ å¤±è´¥ â†’ åœæ­¢å¹¶é€šçŸ¥                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 4: nginx -s reload                â”‚
â”‚  ----------------------------------------â”‚
â”‚  nginx -s reload                        â”‚
â”‚  ----------------------------------------â”‚
â”‚  âœ… æˆåŠŸ â†’ éƒ¨ç½²å®Œæˆ                     â”‚
â”‚  âŒ å¤±è´¥ â†’ é€šçŸ¥å¤±è´¥                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é€ç»“æœåˆ°é’‰é’‰ç¾¤    â”‚
â”‚  - æ‰§è¡Œæ—¶é—´          â”‚
â”‚  - å„æ­¥éª¤çŠ¶æ€        â”‚
â”‚  - é”™è¯¯ä¿¡æ¯(å¦‚æœ‰)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ æ¨¡å—è®¾è®¡

### 1. ä¸»æœåŠ¡æ¨¡å— (`src/index.js`)

**èŒè´£:**
- Express æœåŠ¡å™¨åˆå§‹åŒ–
- è·¯ç”±æ³¨å†Œ
- ä¸­é—´ä»¶é…ç½®
- é”™è¯¯å¤„ç†
- è¿›ç¨‹ç®¡ç†

**æ¥å£:**
- `GET /health` - å¥åº·æ£€æŸ¥
- `POST /webhook/dingtalk` - é’‰é’‰ Webhook å›è°ƒ
- `POST /deploy` - æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

### 2. é…ç½®æ¨¡å— (`src/config.js`)

**èŒè´£:**
- è¯»å–ç¯å¢ƒå˜é‡
- é…ç½®éªŒè¯
- æä¾›é…ç½®è®¿é—®æ¥å£

**é…ç½®é¡¹:**
- æœåŠ¡ç«¯å£
- é’‰é’‰æœºå™¨äººé…ç½®
- é¡¹ç›®è·¯å¾„é…ç½®
- å‘½ä»¤é…ç½®

### 3. é’‰é’‰æ¨¡å— (`src/dingtalk.js`)

**èŒè´£:**
- ç­¾åéªŒè¯
- æ¶ˆæ¯å‘é€ (æ–‡æœ¬/Markdown)
- Webhook è¯·æ±‚å¤„ç†

**æ–¹æ³•:**
- `verifySignature()` - éªŒè¯é’‰é’‰ç­¾å
- `sendTextMessage()` - å‘é€æ–‡æœ¬æ¶ˆæ¯
- `sendMarkdownMessage()` - å‘é€ Markdown æ¶ˆæ¯

### 4. éƒ¨ç½²æ¨¡å— (`src/deploy.js`)

**èŒè´£:**
- æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
- å‘½ä»¤è¾“å‡ºæ•è·
- é”™è¯¯å¤„ç†
- ç»“æœåé¦ˆ

**æ–¹æ³•:**
- `deploy()` - ä¸»éƒ¨ç½²æµç¨‹
- `executeCommand()` - æ‰§è¡Œå•ä¸ªå‘½ä»¤
- `formatDuration()` - æ ¼å¼åŒ–æ‰§è¡Œæ—¶é—´

### 5. æ—¥å¿—æ¨¡å— (`src/utils/logger.js`)

**èŒè´£:**
- æ—¥å¿—è®°å½•
- æ—¥å¿—è½®è½¬
- é”™è¯¯è·Ÿè¸ª

**æ—¥å¿—çº§åˆ«:**
- `info` - ä¸€èˆ¬ä¿¡æ¯
- `warn` - è­¦å‘Šä¿¡æ¯
- `error` - é”™è¯¯ä¿¡æ¯

**æ—¥å¿—æ–‡ä»¶:**
- `deploy-YYYY-MM-DD.log` - æ‰€æœ‰æ—¥å¿—
- `error-YYYY-MM-DD.log` - é”™è¯¯æ—¥å¿—

---

## ğŸ” å®‰å…¨è®¾è®¡

### 1. ç­¾åéªŒè¯

é’‰é’‰æœºå™¨äººä½¿ç”¨ HMAC-SHA256 ç­¾åéªŒè¯:

```
timestamp = å½“å‰æ—¶é—´æˆ³
secret = é’‰é’‰æœºå™¨äººå¯†é’¥
stringToSign = timestamp + "\n" + secret
sign = Base64(HMAC-SHA256(stringToSign, secret))
```

**éªŒè¯æµç¨‹:**
```javascript
function verifySignature(timestamp, sign) {
  const stringToSign = `${timestamp}\n${secret}`;
  const hmac = crypto.createHmac('sha256', secret);
  const computedSign = hmac.update(stringToSign).digest('base64');
  return computedSign === sign;
}
```

### 2. æƒé™æ§åˆ¶

**æœ€å°æƒé™åŸåˆ™:**
- æœåŠ¡è¿è¡Œç”¨æˆ·åªæœ‰å¿…è¦çš„æƒé™
- sudo å…å¯†ä»…é™ nginx reload å‘½ä»¤
- é¡¹ç›®ç›®å½•ä»…å…è®¸ç‰¹å®šç”¨æˆ·è®¿é—®

**å»ºè®®é…ç½®:**
```bash
# /etc/sudoers.d/deploy-bot
deploy-user ALL=(ALL) NOPASSWD: /usr/sbin/nginx -s reload
deploy-user ALL=(ALL) NOPASSWD: /usr/local/nginx/sbin/nginx -s reload
```

### 3. ç½‘ç»œå®‰å…¨

**é˜²ç«å¢™è§„åˆ™:**
- ä»…å¼€æ”¾å¿…è¦ç«¯å£ (80, 443, 3000)
- ä½¿ç”¨ HTTPS åŠ å¯†ä¼ è¾“
- å¯é€‰: IP ç™½åå•é™åˆ¶

**Nginx å®‰å…¨é…ç½®:**
```nginx
# éšè—ç‰ˆæœ¬å·
server_tokens off;

# é™æµ
limit_req_zone $binary_remote_addr zone=deploy:10m rate=10r/m;
limit_req zone=deploy burst=5;

# è¶…æ—¶è®¾ç½®
client_body_timeout 10s;
client_header_timeout 10s;
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥æ‰§è¡Œ

éƒ¨ç½²ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ,é¿å…é˜»å¡ HTTP å“åº”:

```javascript
app.post('/webhook/dingtalk', async (req, res) => {
  // ç«‹å³å“åº”é’‰é’‰æœåŠ¡å™¨
  res.json({ success: true });
  
  // å¼‚æ­¥æ‰§è¡Œéƒ¨ç½²
  deploy().catch(error => {
    logger.error(error);
  });
});
```

### 2. å‘½ä»¤è¶…æ—¶æ§åˆ¶

æ¯ä¸ªå‘½ä»¤è®¾ç½®è¶…æ—¶æ—¶é—´ (5åˆ†é’Ÿ):

```javascript
const { stdout, stderr } = await execPromise(command, {
  cwd: projectPath,
  timeout: 5 * 60 * 1000  // 5åˆ†é’Ÿ
});
```

### 3. æ—¥å¿—è½®è½¬

ä½¿ç”¨ `winston-daily-rotate-file` è‡ªåŠ¨è½®è½¬æ—¥å¿—:
- æ¯å¤©åˆ›å»ºæ–°æ—¥å¿—æ–‡ä»¶
- å•æ–‡ä»¶æœ€å¤§ 20MB
- ä¿ç•™æœ€è¿‘ 14 å¤©

---

## ğŸ”§ å¯æ‰©å±•æ€§

### 1. æ”¯æŒå¤šé¡¹ç›®éƒ¨ç½²

**æ–¹æ¡ˆä¸€: å¤šå®ä¾‹**
```bash
# é¡¹ç›®A
PORT=3001 PROJECT_PATH=/var/www/project-a pm2 start src/index.js --name deploy-a

# é¡¹ç›®B
PORT=3002 PROJECT_PATH=/var/www/project-b pm2 start src/index.js --name deploy-b
```

**æ–¹æ¡ˆäºŒ: è·¯ç”±å‚æ•°**
```javascript
app.post('/webhook/dingtalk/:project', async (req, res) => {
  const project = req.params.project;
  // æ ¹æ® project å‚æ•°é€‰æ‹©ä¸åŒçš„é¡¹ç›®é…ç½®
});
```

### 2. æ”¯æŒæ›´å¤šå‘½ä»¤

ä¿®æ”¹ `src/config.js`:

```javascript
commands: {
  gitPull: (branch) => `git pull origin ${branch}`,
  pnpmInstall: 'pnpm install',
  pnpmBuild: 'pnpm build',
  nginxReload: 'nginx -s reload',
  // æ–°å¢å‘½ä»¤
  dockerBuild: 'docker build -t myapp .',
  dockerRestart: 'docker restart myapp'
}
```

### 3. æ”¯æŒæ¡ä»¶éƒ¨ç½²

æ·»åŠ éƒ¨ç½²æ¡ä»¶åˆ¤æ–­:

```javascript
// ä»…åœ¨å·¥ä½œæ—¶é—´éƒ¨ç½²
// ä»…å…è®¸ç‰¹å®šç”¨æˆ·è§¦å‘
// ä»…åœ¨ç‰¹å®šåˆ†æ”¯æ›´æ–°æ—¶éƒ¨ç½²
```

---

## ğŸ“ˆ ç›‘æ§å’Œå‘Šè­¦

### 1. æœåŠ¡ç›‘æ§

ä½¿ç”¨ PM2 å†…ç½®ç›‘æ§:

```bash
pm2 monit           # å®æ—¶ç›‘æ§
pm2 status          # æŸ¥çœ‹çŠ¶æ€
pm2 describe deploy-bot  # è¯¦ç»†ä¿¡æ¯
```

### 2. æ—¥å¿—ç›‘æ§

å®šæœŸæ£€æŸ¥æ—¥å¿—æ–‡ä»¶:

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f logs/error-*.log

# ç»Ÿè®¡ä»Šæ—¥éƒ¨ç½²æ¬¡æ•°
grep "å¼€å§‹éƒ¨ç½²" logs/deploy-$(date +%Y-%m-%d).log | wc -l

# ç»Ÿè®¡å¤±è´¥æ¬¡æ•°
grep "éƒ¨ç½²å¤±è´¥" logs/deploy-$(date +%Y-%m-%d).log | wc -l
```

### 3. å‘Šè­¦æœºåˆ¶

**éƒ¨ç½²å¤±è´¥å‘Šè­¦:**
- è‡ªåŠ¨å‘é€é’‰é’‰æ¶ˆæ¯
- è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
- å¯é€‰: å‘é€é‚®ä»¶/çŸ­ä¿¡

**æœåŠ¡å¼‚å¸¸å‘Šè­¦:**
```bash
# PM2 è‡ªåŠ¨é‡å¯
pm2 start ecosystem.config.js

# é…ç½®æœ€å¤§é‡å¯æ¬¡æ•°
max_restarts: 10
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

å¯¹å…³é”®æ¨¡å—ç¼–å†™å•å…ƒæµ‹è¯•:
- ç­¾åéªŒè¯
- å‘½ä»¤æ‰§è¡Œ
- æ¶ˆæ¯å‘é€

### 2. é›†æˆæµ‹è¯•

æµ‹è¯•å®Œæ•´éƒ¨ç½²æµç¨‹:
- æ¨¡æ‹Ÿé’‰é’‰ Webhook è°ƒç”¨
- éªŒè¯å‘½ä»¤æ‰§è¡Œé¡ºåº
- æ£€æŸ¥ç»“æœåé¦ˆ

### 3. å‹åŠ›æµ‹è¯•

æµ‹è¯•å¹¶å‘éƒ¨ç½²è¯·æ±‚:
- å¤šä¸ªç”¨æˆ·åŒæ—¶è§¦å‘
- é˜²æ­¢é‡å¤æ‰§è¡Œ
- é˜Ÿåˆ—ç®¡ç†

---

## ğŸ”„ ç¾éš¾æ¢å¤

### 1. å¤‡ä»½ç­–ç•¥

**ä»£ç å¤‡ä»½:**
```bash
# è‡ªåŠ¨å¤‡ä»½åˆ° Git è¿œç¨‹ä»“åº“
git push origin main
```

**é…ç½®å¤‡ä»½:**
```bash
# å®šæœŸå¤‡ä»½ .env æ–‡ä»¶ (åŠ å¯†å­˜å‚¨)
cp .env .env.backup.$(date +%Y%m%d)
```

### 2. å›æ»šæ–¹æ¡ˆ

**æ‰‹åŠ¨å›æ»š:**
```bash
cd /var/www/your-project
git log --oneline -10  # æŸ¥çœ‹æäº¤å†å²
git reset --hard <commit-id>  # å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
pnpm install
pnpm build
nginx -s reload
```

**è‡ªåŠ¨å›æ»š (TODO):**
- è®°å½•æ¯æ¬¡éƒ¨ç½²çš„ commit id
- å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬

### 3. æ•…éšœè½¬ç§»

**æœåŠ¡æŒ‚æ‰:**
- PM2 è‡ªåŠ¨é‡å¯
- å¯é…ç½®å¤šå®ä¾‹è´Ÿè½½å‡è¡¡

**æ•°æ®åº“æŒ‚æ‰:**
- æœ¬é¡¹ç›®ä¸ä¾èµ–æ•°æ®åº“
- å¦‚éœ€è¦,å»ºè®®ä½¿ç”¨ä¸»ä»å¤åˆ¶

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [é’‰é’‰æœºå™¨äººå¼€å‘æ–‡æ¡£](https://open.dingtalk.com/document/robots/custom-robot-access)
- [Express å®˜æ–¹æ–‡æ¡£](https://expressjs.com/)
- [PM2 å®˜æ–¹æ–‡æ¡£](https://pm2.keymetrics.io/)
- [Winston æ—¥å¿—åº“](https://github.com/winstonjs/winston)
- [Node.js Child Process](https://nodejs.org/api/child_process.html)

---

**ç‰ˆæœ¬:** 1.0.0  
**æœ€åæ›´æ–°:** 2024-12-30

